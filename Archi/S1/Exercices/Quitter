#!/bin/bash

## Vérifier si le dossier existe, sinon le créer ##
if [ ! -d ~/.quitter ]
then
mkdir ~/.quitter
fi

## On se place dans le dossier ##
cd ~/.quitter
touch boucle.pid

## On regarde ce que l'utilisateur a entré et on en déduit les fonctions à éxecuter ##
if [ $# -eq 1 ]
then
case $1 in

## Option pour arrêter la boucle ##
-q)
pid=$(cat boucle.pid)
kill -9 $pid
rm boucle.pid
exit 1
;;

## Afficher tous les rdv ##
-l)
cat -n horaires.db
exit 1
;;

esac

## Si plus de deux paramètres, on change de 'case' ##
elif [ $# -eq 2 ]
then

## Stockage données utilisateur ##

case $1 in

-r)
sed -i "$2d" horaires.db
echo "Ligne $2 supprimée"
exit 1
;;

*)
heureRDV=$1
comentUSER=$2
;;

esac
fi

## Stockage des données utlisateur dans le fichier ##
echo "$heureRDV: $comentUSER" >> ~/.quitter/horaires.db

## On calcule le nombre de lignes du document ##
nbLignes=$(< horaires.db wc -l)

## Fonction de la boucle infinie qui rappelle le rdv lorsque l'heure est arrivée ##
function boucle
{
while [ $nbLignes -ne 0 ]
do
echo $$ > boucle.pid
    sleep 30
    for i in $(seq 1 $nbLignes)
    do
        horaire=$(sed "${i}q;d" horaires.db | cut -d: -f1)
        date=$(date +%H%M)
        message=$(sed "${i}q;d" horaires.db)
        if [ $date = $horaire ]
        then
        xmessage $message -buttons FERMER
        sed -i "${i}d" horaires.db
        nbLignes=$(< horaires.db wc -l)
        fi
    done
done
}

## Lancement de la boucle ##
if [ -s boucle.pid ]
then
echo "Boucle déjà lancée"
else
boucle
fi